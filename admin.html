<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="login-overlay">
      <h2>Admin Panel</h2>
      <input
        type="email"
        id="emailInput"
        style="max-width: 280px; margin-bottom: 10px"
        placeholder="Email"
      />
      <input
        type="password"
        id="passInput"
        style="max-width: 280px; margin-bottom: 15px"
        placeholder="Enter password"
        placeholder="Password"
      />
      <p
        id="loginError"
        style="
          color: #ff6b6b;
          display: none;
          margin-bottom: 10px;
          font-size: 0.9rem;
        "
      ></p>
      <div class="btn-group" style="width: 280px">
        <button class="btn" onclick="login()">Login</button>
        <button
          class="btn btn-home"
          onclick="window.location.href = 'index.html'"
        >
          Exit
        </button>
      </div>
    </div>

    <div id="modal-overlay">
      <div class="modal">
        <h3>Karte geschpeichert!</h3>
        <p>Eine weitere Karte erstellen?</p>
        <div class="btn-group">
          <button class="btn" onclick="resetForNew()">Ja</button>
          <button
            class="btn btn-home"
            onclick="window.location.href = 'index.html'"
          >
            Nein (Home)
          </button>
        </div>
      </div>
    </div>

    <div class="admin-container">
      <h2>Create Flashcard</h2>
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-top: 2rem;
          margin-bottom: 2.5rem;
        "
      >
        <button
          class="btn btn-home"
          onclick="logout()"
          style="padding: 8px 15px; font-size: 0.8rem; flex: 0 0 auto"
        >
          Logout
        </button>
      </div>
      <form id="cardForm">
        <div class="form-section">
          <label>Category</label>
          <select id="categorySelect">
            <option value="">☞ Select Category</option>
            <option value="Projektmanagement">Projektmanagement</option>
            <option value="Datenschutz">Datenschutz</option>
            <option value="IT-Sicherheit">IT-Sicherheit</option>
            <option value="Qualitätsmanagement">Qualitätsmanagement</option>
          </select>
        </div>
        <div class="form-section">
          <label>Tags</label>
          <input type="text" id="tags" placeholder="scrum, tech, security" />
        </div>
        <div class="form-section">
          <label>Frontside Title (Question)</label>
          <input
            type="text"
            id="frontTitle"
            placeholder="Ej: ¿Qué es GDPR?"
            style="margin-bottom: 15px"
          />

          <label>Frontside Content (Details/Image)</label>
          <div id="editor-front" style="background: white; color: black"></div>
        </div>
        <div class="form-section">
          <label>Backside (Answer/Details)</label>
          <div id="editor-back" style="background: white; color: black"></div>
        </div>

        <div class="btn-group">
          <button type="submit" class="btn">SAVE CARD</button>
          <button
            type="button"
            class="btn btn-cancel"
            onclick="window.location.href = 'index.html'"
          >
            CANCEL
          </button>
        </div>
      </form>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
      const quillConfig = {
        theme: "snow",
        modules: {
          toolbar: [
            [{ header: [1, 2, 3, false] }],
            ["bold", "italic", "underline"],
            [{ color: [] }, { background: [] }],
            [{ list: "ordered" }, { list: "bullet" }],
            [{ align: [] }],
            ["blockquote", "code", "code-block"],
            ["link", "image"],
            ["clean"],
          ],
        },
      };

      const qFront = new Quill("#editor-front", quillConfig);
      const qBack = new Quill("#editor-back", quillConfig);

      // Verificar sesión al cargar
      async function checkSession() {
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
        if (session) {
          document.getElementById("login-overlay").style.display = "none";
        }
      }
      checkSession();

      async function login() {
        const email = document.getElementById("emailInput").value;
        const password = document.getElementById("passInput").value;
        const errorEl = document.getElementById("loginError");

        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password,
        });

        if (error) {
          errorEl.textContent = "Error: " + error.message;
          errorEl.style.display = "block";
        } else {
          errorEl.style.display = "none";
          document.getElementById("login-overlay").style.display = "none";
        }
      }

      document
        .getElementById("cardForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const cat = document.getElementById("categorySelect").value;
          const title = DOMPurify.sanitize(
            document.getElementById("frontTitle").value,
          );
          const tags = DOMPurify.sanitize(
            document.getElementById("tags").value,
          );
          const frontHtml = DOMPurify.sanitize(qFront.root.innerHTML.trim(), {
            ADD_ATTR: ["style"],
          });
          const backHtml = DOMPurify.sanitize(qBack.root.innerHTML.trim(), {
            ADD_ATTR: ["style"],
          });

          const isFrontEmpty =
            qFront.getText().trim().length === 0 && !frontHtml.includes("<img");
          const isBackEmpty =
            qBack.getText().trim().length === 0 && !backHtml.includes("<img");

          if (!cat || !title || !tags || isFrontEmpty || isBackEmpty) {
            alert("Rellena todos los campos");
            return;
          }

          // Guardar en Supabase
          saveCardToSupabase({
            category: cat,
            front_title: title,
            tags: tags,
            front_content: frontHtml,
            back_content: backHtml,
          });
        });

      async function saveCardToSupabase(cardData) {
        const { data, error } = await supabaseClient
          .from("cards")
          .insert([cardData]);
        if (error) {
          alert("Error al guardar: " + error.message);
        } else {
          document.getElementById("modal-overlay").style.display = "flex";
        }
      }

      async function logout() {
        const { error } = await supabaseClient.auth.signOut();
        if (!error) {
          window.location.reload();
        }
      }

      function resetForNew() {
        document.getElementById("modal-overlay").style.display = "none";
        document.getElementById("cardForm").reset();
        qFront.setContents([]);
        qBack.setContents([]);
        window.scrollTo(0, 0);
      }
    </script>
  </body>
</html>
