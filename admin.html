<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Panel</title>
    <link
      href="https://cdn.quilljs.com/1.3.6/quill.snow.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div id="login-overlay">
      <h2>Admin Panel</h2>
      <input
        type="email"
        id="emailInput"
        style="max-width: 280px; margin-bottom: 10px"
        placeholder="Email"
      />
      <input
        type="password"
        id="passInput"
        style="max-width: 280px; margin-bottom: 15px"
        placeholder="Enter password"
        placeholder="Password"
      />
      <p
        id="loginError"
        style="
          color: #ff6b6b;
          display: none;
          margin-bottom: 10px;
          font-size: 0.9rem;
        "
      ></p>
      <div class="btn-group" style="width: 280px">
        <button class="btn" onclick="login()">Login</button>
        <button
          class="btn btn-home"
          onclick="window.location.href = 'index.html'"
        >
          Exit
        </button>
      </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Borrado (Alem√°n) -->
    <div
      id="delete-modal-overlay"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      "
    >
      <div class="modal">
        <h3 style="color: #ff6b6b">Karte l√∂schen?</h3>
        <p>
          M√∂chten Sie diese Karte wirklich l√∂schen? Diese Aktion kann nicht
          r√ºckg√§ngig gemacht werden.
        </p>
        <div class="btn-group">
          <button
            class="btn"
            style="background: #ff6b6b; color: white"
            onclick="confirmDelete()"
          >
            L√∂schen
          </button>
          <button class="btn btn-home" onclick="closeDeleteModal()">
            Abbrechen
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de √âxito -->
    <div id="modal-overlay">
      <div class="modal">
        <h3>Karte geschpeichert!</h3>
        <p>Eine weitere Karte erstellen?</p>
        <div class="btn-group">
          <button class="btn" onclick="resetForNew()">Ja</button>
          <button class="btn btn-home" onclick="showView('cards-view')">
            Nein (Zur√ºck)
          </button>
        </div>
      </div>
    </div>

    <!-- Modal de Confirmaci√≥n de Borrado de Categor√≠a -->
    <div
      id="delete-cat-modal-overlay"
      style="
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.8);
        z-index: 2000;
        align-items: center;
        justify-content: center;
      "
    >
      <div class="modal">
        <h3 style="color: #ff6b6b">Kategorie l√∂schen?</h3>
        <p id="delete-cat-msg"></p>
        <div class="btn-group">
          <button
            class="btn"
            style="background: #ff6b6b; color: white"
            onclick="confirmDeleteCategory()"
          >
            L√∂schen
          </button>
          <button class="btn btn-home" onclick="closeDeleteCatModal()">
            Abbrechen
          </button>
        </div>
      </div>
    </div>

    <div class="admin-container">
      <!-- Header Admin -->
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-top: 2rem;
          margin-bottom: 2.5rem;
          border-bottom: 1px solid var(--border-color);
          padding-bottom: 1rem;
        "
      >
        <h2
          style="margin: 0; cursor: pointer"
          onclick="showView('dashboard-view')"
        >
          Admin Panel
        </h2>
        <button
          class="btn btn-home"
          onclick="logout()"
          style="padding: 8px 15px; font-size: 0.8rem; flex: 0 0 auto"
        >
          Logout ‚ûú
        </button>
      </div>

      <!-- VISTA 1: DASHBOARD -->
      <div id="dashboard-view">
        <div class="dashboard-menu">
          <div class="dashboard-card" onclick="showView('categories-view')">
            <span style="font-size: 2rem">üìÇ</span>
            <h3>Admin Categories</h3>
          </div>
          <div class="dashboard-card" onclick="showView('cards-view')">
            <span style="font-size: 2rem">üóÇÔ∏è</span>
            <h3>Admin Cards</h3>
          </div>
        </div>
      </div>

      <!-- VISTA 2: CATEGORIAS -->
      <div id="categories-view" class="hidden">
        <h3>Manage Categories</h3>
        <div class="search-box" style="margin-bottom: 20px">
          <input type="text" id="newCatInput" placeholder="New Category Name" />
          <div class="btn-group">
            <button class="btn btn-home" onclick="showView('dashboard-view')">
              Back to Dashboard
            </button>
            <button class="btn" onclick="addCategory()">Add</button>
          </div>
        </div>
        <div id="categories-list" class="admin-list">
          <!-- Lista din√°mica -->
        </div>
      </div>

      <!-- VISTA 3: TARJETAS (LISTA) -->
      <div id="cards-view" class="hidden">
        <div style="display: flex; gap: 10px; margin-bottom: 20px">
          <input
            type="text"
            id="adminSearchInput"
            placeholder="Search by ID or Text..."
          />
          <button class="btn" onclick="searchAdminCards()">Search</button>
          <button
            class="btn"
            onclick="prepareCreateCard()"
            style="background: var(--accent); color: var(--bg-dark)"
          >
            + New Card
          </button>
        </div>
        <div id="cards-list" class="admin-list">
          <!-- Lista din√°mica -->
        </div>
        <button
          class="btn btn-home"
          onclick="showView('dashboard-view')"
          style="margin-top: 20px"
        >
          Back to Dashboard
        </button>
      </div>

      <!-- VISTA 4: FORMULARIO TARJETA (CREAR/EDITAR) -->
      <div id="card-form-view" class="hidden">
        <h3 id="formTitle">Create Flashcard</h3>
        <form id="cardForm">
          <input type="hidden" id="editCardId" />
          <!-- ID oculto para edici√≥n -->
          <div class="form-section">
            <label>Category</label>
            <select id="categorySelect">
              <option value="">Loading...</option>
            </select>
          </div>
          <div class="form-section">
            <label>Tags</label>
            <input type="text" id="tags" placeholder="scrum, tech, security" />
          </div>
          <div class="form-section">
            <label>Frontside Title (Question)</label>
            <input
              type="text"
              id="frontTitle"
              placeholder="Ej: ¬øQu√© es GDPR?"
              style="margin-bottom: 15px"
            />

            <label>Frontside Content (Details/Image)</label>
            <div
              id="editor-front"
              style="background: white; color: black"
            ></div>
          </div>
          <div class="form-section">
            <label>Backside (Answer/Details)</label>
            <div id="editor-back" style="background: white; color: black"></div>
          </div>

          <div class="btn-group">
            <button type="submit" class="btn" id="saveBtn">SAVE CARD</button>
            <button
              type="button"
              class="btn"
              id="deleteBtn"
              style="background: #ff6b6b; color: white; display: none"
              onclick="askDeleteCard()"
            >
              DELETE CARD
            </button>
            <button
              type="button"
              class="btn btn-cancel"
              onclick="showView('cards-view')"
            >
              CANCEL
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.8/purify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
      const quillConfig = {
        theme: "snow",
        modules: {
          toolbar: [
            [{ header: [1, 2, 3, false] }],
            ["bold", "italic", "underline"],
            [{ color: [] }, { background: [] }],
            [{ list: "ordered" }, { list: "bullet" }],
            [{ align: [] }],
            ["blockquote", "code", "code-block"],
            ["link", "image"],
            ["clean"],
          ],
        },
      };

      const qFront = new Quill("#editor-front", quillConfig);
      const qBack = new Quill("#editor-back", quillConfig);

      // Variables globales
      let allCategories = [];
      let cardToDeleteId = null;
      let catToDeleteId = null;
      let catToDeleteName = null;

      // Verificar sesi√≥n al cargar
      async function checkSession() {
        const {
          data: { session },
        } = await supabaseClient.auth.getSession();
        if (session) {
          document.getElementById("login-overlay").style.display = "none";
          loadCategories(); // Cargar categor√≠as al iniciar
          showView("dashboard-view");
        }
      }
      checkSession();

      async function login() {
        const email = document.getElementById("emailInput").value;
        const password = document.getElementById("passInput").value;
        const errorEl = document.getElementById("loginError");

        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password,
        });

        if (error) {
          errorEl.textContent = "Error: " + error.message;
          errorEl.style.display = "block";
        } else {
          errorEl.style.display = "none";
          document.getElementById("login-overlay").style.display = "none";
          loadCategories();
          showView("dashboard-view");
        }
      }

      // --- GESTI√ìN DE VISTAS ---
      function showView(viewId) {
        // Ocultar todas
        [
          "dashboard-view",
          "categories-view",
          "cards-view",
          "card-form-view",
        ].forEach((id) => {
          document.getElementById(id).classList.add("hidden");
        });
        // Mostrar seleccionada
        document.getElementById(viewId).classList.remove("hidden");

        if (viewId === "categories-view") renderCategoriesList();
        if (viewId === "cards-view") searchAdminCards(); // Cargar todas al entrar
      }

      // --- GESTI√ìN DE CATEGOR√çAS ---
      async function loadCategories() {
        const { data, error } = await supabaseClient
          .from("categories")
          .select("*")
          .order("name");
        if (data) {
          allCategories = data;
          updateCategorySelect();
        }
      }

      function updateCategorySelect() {
        const select = document.getElementById("categorySelect");
        select.innerHTML = '<option value="">‚òû Select Category</option>';
        allCategories.forEach((cat) => {
          const option = document.createElement("option");
          option.value = cat.name;
          option.textContent = cat.name;
          select.appendChild(option);
        });
      }

      function renderCategoriesList() {
        const list = document.getElementById("categories-list");
        list.innerHTML = "";
        allCategories.forEach((cat) => {
          const item = document.createElement("div");
          item.className = "admin-list-item";
          item.innerHTML = `
            <div style="font-weight: bold;">${DOMPurify.sanitize(cat.name)}</div>
            <div style="display: flex; gap: 5px; justify-content: flex-end; flex: 0 0 auto;">
              <button class="btn" style="padding: 5px 10px; font-size: 0.8rem;" onclick="editCategory(${cat.id})">Edit</button>
              <button class="btn" style="background: #ff6b6b; color: white; padding: 5px 10px; font-size: 0.8rem;" onclick="askDeleteCategory(${cat.id})">Delete</button>
            </div>
          `;
          list.appendChild(item);
        });
      }

      async function addCategory() {
        const name = document.getElementById("newCatInput").value.trim();
        if (!name) return;
        const { error } = await supabaseClient
          .from("categories")
          .insert([{ name }]);
        if (!error) {
          document.getElementById("newCatInput").value = "";
          await loadCategories();
          renderCategoriesList();
        } else {
          alert("Error: " + error.message);
        }
      }

      async function editCategory(id) {
        const cat = allCategories.find((c) => c.id === id);
        if (!cat) return;

        const newName = prompt("Neuer Name f√ºr Kategorie:", cat.name);
        if (newName && newName.trim() !== "" && newName !== cat.name) {
          const trimmedName = newName.trim();

          // 1. Actualizar nombre en tabla categories
          const { error: catError } = await supabaseClient
            .from("categories")
            .update({ name: trimmedName })
            .eq("id", id);

          if (catError) {
            alert("Error updating category: " + catError.message);
            return;
          }

          // 2. Actualizar todas las tarjetas asociadas (Cascada manual)
          const { error: cardsError } = await supabaseClient
            .from("cards")
            .update({ category: trimmedName })
            .eq("category", cat.name);

          if (cardsError) {
            alert(
              "Warning: Category updated but cards update failed: " +
                cardsError.message,
            );
          }

          await loadCategories();
          renderCategoriesList();
        }
      }

      async function askDeleteCategory(id) {
        const cat = allCategories.find((c) => c.id === id);
        if (!cat) return;

        catToDeleteId = id;
        catToDeleteName = cat.name;

        // Contar tarjetas afectadas
        const { count, error } = await supabaseClient
          .from("cards")
          .select("*", { count: "exact", head: true })
          .eq("category", cat.name);

        if (error) {
          alert("Error counting cards: " + error.message);
          return;
        }

        const msg = `M√∂chten Sie die Kategorie "${cat.name}" wirklich l√∂schen? ${count} zugeh√∂rige Karten werden ebenfalls gel√∂scht.`;
        document.getElementById("delete-cat-msg").textContent = msg;
        document.getElementById("delete-cat-modal-overlay").style.display =
          "flex";
      }

      async function confirmDeleteCategory() {
        if (!catToDeleteId || !catToDeleteName) return;

        // 1. Borrar tarjetas asociadas
        await supabaseClient
          .from("cards")
          .delete()
          .eq("category", catToDeleteName);

        // 2. Borrar categor√≠a
        const { error } = await supabaseClient
          .from("categories")
          .delete()
          .eq("id", catToDeleteId);

        if (error) {
          alert("Error deleting category: " + error.message);
        } else {
          closeDeleteCatModal();
          await loadCategories();
          renderCategoriesList();
        }
      }

      function closeDeleteCatModal() {
        document.getElementById("delete-cat-modal-overlay").style.display =
          "none";
        catToDeleteId = null;
        catToDeleteName = null;
      }

      // --- GESTI√ìN DE TARJETAS ---
      async function searchAdminCards() {
        const term = document.getElementById("adminSearchInput").value.trim();
        const list = document.getElementById("cards-list");
        list.innerHTML = "<p>Loading...</p>";

        let query = supabaseClient
          .from("cards")
          .select("*")
          .order("created_at", { ascending: false });

        if (term) {
          if (!isNaN(term)) {
            // Es un n√∫mero, buscar por ID
            query = query.eq("id", term);
          } else {
            // Es texto, buscar por t√≠tulo
            query = query.ilike("front_title", `%${term}%`);
          }
        }

        const { data, error } = await query;

        list.innerHTML = "";
        if (data && data.length > 0) {
          data.forEach((card) => {
            const item = document.createElement("div");
            item.className = "admin-list-item";
            item.innerHTML = `
              <div style="flex: 0 0 50px; font-weight: bold;">#${card.id}</div>
              <div style="flex: 2;">${card.front_title}</div>
              <div style="flex: 1; color: var(--accent);">${card.category}</div>
              <button class="btn" style="flex: 0 0 60px; padding: 5px;" onclick="editCard(${card.id})">‚úèÔ∏è</button>
            `;
            list.appendChild(item);
          });
        } else {
          list.innerHTML = "<p>No cards found.</p>";
        }
      }

      document
        .getElementById("cardForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const id = document.getElementById("editCardId").value;
          const cat = document.getElementById("categorySelect").value;
          const title = DOMPurify.sanitize(
            document.getElementById("frontTitle").value,
          );
          const tags = DOMPurify.sanitize(
            document.getElementById("tags").value,
          );
          const frontHtml = DOMPurify.sanitize(qFront.root.innerHTML.trim(), {
            ADD_ATTR: ["style"],
          });
          const backHtml = DOMPurify.sanitize(qBack.root.innerHTML.trim(), {
            ADD_ATTR: ["style"],
          });

          const isFrontEmpty =
            qFront.getText().trim().length === 0 && !frontHtml.includes("<img");
          const isBackEmpty =
            qBack.getText().trim().length === 0 && !backHtml.includes("<img");

          if (!cat || !title || !tags || isFrontEmpty || isBackEmpty) {
            alert("Rellena todos los campos");
            return;
          }

          // Guardar en Supabase
          const cardData = {
            category: cat,
            front_title: title,
            tags: tags,
            front_content: frontHtml,
            back_content: backHtml,
          };

          saveCardToSupabase(cardData, id);
        });

      function prepareCreateCard() {
        resetForNew();
        document.getElementById("formTitle").textContent = "Create Flashcard";
        document.getElementById("saveBtn").textContent = "SAVE CARD";
        document.getElementById("deleteBtn").style.display = "none";
        document.getElementById("editCardId").value = "";
        showView("card-form-view");
      }

      async function editCard(id) {
        const { data, error } = await supabaseClient
          .from("cards")
          .select("*")
          .eq("id", id)
          .single();
        if (data) {
          document.getElementById("formTitle").textContent = `Edit Card #${id}`;
          document.getElementById("saveBtn").textContent = "UPDATE CARD";
          document.getElementById("deleteBtn").style.display = "inline-block";
          document.getElementById("editCardId").value = id;

          document.getElementById("categorySelect").value = data.category;
          document.getElementById("tags").value = data.tags || "";
          document.getElementById("frontTitle").value = data.front_title;
          qFront.clipboard.dangerouslyPasteHTML(data.front_content);
          qBack.clipboard.dangerouslyPasteHTML(data.back_content);

          showView("card-form-view");
        }
      }

      function askDeleteCard() {
        cardToDeleteId = document.getElementById("editCardId").value;
        document.getElementById("delete-modal-overlay").style.display = "flex";
      }

      function closeDeleteModal() {
        document.getElementById("delete-modal-overlay").style.display = "none";
        cardToDeleteId = null;
      }

      async function confirmDelete() {
        if (cardToDeleteId) {
          const { error } = await supabaseClient
            .from("cards")
            .delete()
            .eq("id", cardToDeleteId);
          if (!error) {
            closeDeleteModal();
            showView("cards-view");
          } else {
            alert("Error deleting: " + error.message);
          }
        }
      }

      async function saveCardToSupabase(cardData, id = null) {
        let result;
        if (id) {
          // Update
          result = await supabaseClient
            .from("cards")
            .update(cardData)
            .eq("id", id);
        } else {
          // Insert
          result = await supabaseClient.from("cards").insert([cardData]);
        }

        const { error } = result;

        if (error) {
          alert("Error al guardar: " + error.message);
        } else {
          document.getElementById("modal-overlay").style.display = "flex";
        }
      }

      async function logout() {
        const { error } = await supabaseClient.auth.signOut();
        if (!error) {
          window.location.href = "index.html";
        }
      }

      function resetForNew() {
        document.getElementById("modal-overlay").style.display = "none";
        document.getElementById("cardForm").reset();
        qFront.setContents([]);
        qBack.setContents([]);
        window.scrollTo(0, 0);
      }
    </script>
  </body>
</html>
